# 自动续期功能测试清单

## 🔍 已修复的问题

### 1. ✅ localStorage Key 不一致
- **问题**: ACMEClient 使用 `q-certs`，但实际存储使用 `q-manageDataPairs`
- **修复**: 统一使用 `q-manageDataPairs`
- **影响**: 证书存储和更新现在可以正常工作

### 2. ✅ 已弃用的 substr() 方法
- **问题**: RenewalScheduler 使用已弃用的 `substr()`
- **修复**: 替换为 `substring()`
- **影响**: 消除弃用警告，提高代码兼容性

### 3. ✅ 未使用的变量
- **问题**: CertificateScanner 中的 `now` 变量未使用
- **修复**: 移除未使用的变量
- **影响**: 清理代码，消除警告

### 4. ✅ window.ACME 可用性问题（严重）
- **问题**: `window.ACME` 只在首页加载，其他页面不可用
- **修复**: 在 `_app.js` 中全局加载 `depend()`
- **影响**: 自动续期现在可以在任何页面运行

## 📋 功能测试清单

### 基础功能测试

- [ ] **证书扫描**
  - [ ] 扫描 localStorage 中的所有证书
  - [ ] 正确解析证书数据
  - [ ] 计算到期时间准确（90天有效期）
  - [ ] 识别临期证书（默认30天阈值）

- [ ] **配置管理**
  - [ ] 全局自动续期开关工作正常
  - [ ] 续期阈值配置生效（1-60天）
  - [ ] 单证书级别开关工作正常
  - [ ] 配置持久化到 localStorage

- [ ] **调度器启动/停止**
  - [ ] 应用启动时自动启动调度器（如果启用）
  - [ ] 应用关闭时正确停止调度器
  - [ ] 24小时定时检查正常运行
  - [ ] 不会重复启动调度器

### ACME 客户端测试

- [ ] **前置条件检查**
  - [ ] 检测 ACME 账户密钥是否存在
  - [ ] 检测邮箱是否配置
  - [ ] 检测证书数据完整性
  - [ ] 检测 window.ACME 是否可用

- [ ] **配置加载**
  - [ ] 正确加载 ACME 账户密钥
  - [ ] 正确解析证书私钥
  - [ ] 正确解析域名（字符串和数组格式）
  - [ ] 使用正确的 ACME URL

- [ ] **ACME 协议流程**
  - [ ] 加载 ACME 目录成功
  - [ ] 创建/验证 ACME 账户成功
  - [ ] 创建新订单成功
  - [ ] 检查授权状态准确
  - [ ] 授权有效时自动完成续期
  - [ ] 授权过期时返回手动验证提示

- [ ] **证书存储**
  - [ ] 正确找到原证书
  - [ ] 更新证书数据
  - [ ] 保存到正确的 localStorage key
  - [ ] 保留其他证书数据不变

### 续期调度器测试

- [ ] **证书检查**
  - [ ] 定时检查所有证书
  - [ ] 只处理启用自动续期的证书
  - [ ] 跳过已在续期中的证书
  - [ ] 正确识别临期证书

- [ ] **续期任务执行**
  - [ ] 创建续期任务
  - [ ] 更新证书状态为 in_progress
  - [ ] 调用 ACMEClient 执行续期
  - [ ] 处理成功结果
  - [ ] 处理失败结果
  - [ ] 处理需要手动验证的情况

- [ ] **状态更新**
  - [ ] 更新证书续期状态
  - [ ] 记录续期历史
  - [ ] 更新最后检查时间
  - [ ] 清理通知标记（成功时）

### Telegram 通知测试

- [ ] **配置**
  - [ ] Bot Token 配置正确
  - [ ] Chat ID 配置正确
  - [ ] 测试连接功能工作

- [ ] **通知发送**
  - [ ] 证书临期通知（只发送一次）
  - [ ] 续期失败通知
  - [ ] 需要手动验证通知
  - [ ] 成功时不发送通知（按需求）

### 历史记录测试

- [ ] **记录管理**
  - [ ] 记录续期开始
  - [ ] 记录续期成功
  - [ ] 记录续期失败
  - [ ] 记录手动验证需求
  - [ ] 最多保留10条记录
  - [ ] 统计数据准确

## 🧪 边界情况测试

### 并发和竞态条件

- [ ] **多个证书同时到期**
  - [ ] 顺序处理所有证书
  - [ ] 不会相互干扰
  - [ ] 状态更新正确

- [ ] **重复启动调度器**
  - [ ] 检测已运行状态
  - [ ] 不会创建多个定时器
  - [ ] 日志提示已运行

- [ ] **续期进行中时再次触发**
  - [ ] 检测 isRenewing 标志
  - [ ] 跳过正在续期的证书
  - [ ] 返回正确状态

### 错误处理

- [ ] **localStorage 不可用**
  - [ ] 捕获异常
  - [ ] 返回友好错误消息
  - [ ] 不会崩溃

- [ ] **证书数据损坏**
  - [ ] JSON 解析失败时处理
  - [ ] 跳过无效证书
  - [ ] 记录错误日志

- [ ] **网络错误**
  - [ ] ACME API 调用失败
  - [ ] 超时处理
  - [ ] 重试逻辑（如果有）

- [ ] **授权过期**
  - [ ] 正确识别授权状态
  - [ ] 返回需要手动验证
  - [ ] 提供续期 URL

### 数据一致性

- [ ] **证书 ID 匹配**
  - [ ] 通过 domains 匹配
  - [ ] 通过 time 匹配（备用）
  - [ ] 找不到时报错

- [ ] **域名格式处理**
  - [ ] 字符串格式（逗号分隔）
  - [ ] 数组格式
  - [ ] 去除空格
  - [ ] 无效格式报错

## 🔐 安全性测试

- [ ] **密钥安全**
  - [ ] 私钥不会泄露到日志
  - [ ] 账户密钥安全存储
  - [ ] 不会在网络请求中暴露

- [ ] **会话验证**
  - [ ] 受保护页面需要登录
  - [ ] 会话过期正确处理
  - [ ] 登出清理会话

## 📊 性能测试

- [ ] **大量证书**
  - [ ] 扫描100+证书性能
  - [ ] 内存使用合理
  - [ ] 不会阻塞 UI

- [ ] **长时间运行**
  - [ ] 24小时运行稳定
  - [ ] 内存不会泄漏
  - [ ] 定时器准确

## 🌐 浏览器兼容性

- [ ] **Chrome/Edge**
  - [ ] 所有功能正常
  - [ ] Web Crypto API 可用
  - [ ] localStorage 可用

- [ ] **Firefox**
  - [ ] 所有功能正常
  - [ ] Web Crypto API 可用
  - [ ] localStorage 可用

- [ ] **Safari**
  - [ ] 所有功能正常
  - [ ] Web Crypto API 可用
  - [ ] localStorage 可用

## 📝 用户体验测试

- [ ] **首次使用**
  - [ ] 提示配置 ACME 账户
  - [ ] 提示配置邮箱
  - [ ] 引导完成初始设置

- [ ] **正常使用**
  - [ ] 自动续期静默运行
  - [ ] 成功时无打扰
  - [ ] 失败时及时通知

- [ ] **错误提示**
  - [ ] 错误消息清晰
  - [ ] 提供解决方案
  - [ ] 包含续期 URL

## 🐛 已知限制

1. **浏览器依赖**: 需要浏览器保持打开
2. **授权缓存**: 仅在30天内有效
3. **网络要求**: 需要稳定网络连接
4. **静态部署**: 无后端服务支持

## ✅ 测试通过标准

- [ ] 所有基础功能测试通过
- [ ] 所有边界情况处理正确
- [ ] 无控制台错误或警告
- [ ] 性能满足要求
- [ ] 用户体验流畅
- [ ] 文档完整准确

## 📞 测试报告

测试日期: ___________
测试人员: ___________
测试环境: ___________

### 发现的问题

1. 
2. 
3. 

### 建议改进

1. 
2. 
3. 

### 总体评价

□ 通过 □ 有问题需修复 □ 需要重新测试
